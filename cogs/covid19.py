  
import discord
import asyncio
from discord.ext import commands
import urllib
from urllib.request import URLError
from urllib.request import HTTPError
from urllib.request import urlopen
from urllib.request import Request, urlopen
from bs4 import BeautifulSoup
from urllib.parse import quote
import re # Regex for youtube link
import warnings
import requests
import time
import aiosqlite

from discord.ext.commands.core import Command, command


class covid19(commands.Cog, name = "ì½”ë¡œë‚˜í˜„í™© ëª…ë ¹ì–´"):
    def __init__(self, bot):
        self.bot = bot
    async def cog_before_invoke(self, ctx: commands.Context):
        print(ctx.command)
        if ctx.command.name != 'ë©”ì¼':
            database = await aiosqlite.connect("db/db.sqlite")
            cur = await database.execute(
                'SELECT * FROM uncheck WHERE user_id = ?', (ctx.author.id,)
            )

            if await cur.fetchone() is None:
                cur = await database.execute("SELECT * FROM mail")
                mails = await cur.fetchall()
                check = sum(1 for _ in mails)
                mal = discord.Embed(
                    title=f'ğŸ“«ë¼ì´ì   ë©”ì¼í•¨ | {check}ê°œ ìˆ˜ì‹ ë¨',
                    description="ì•„ì§ ì½ì§€ ì•Šì€ ë©”ì¼ì´ ìˆì–´ìš”.'`>ë©”ì¼`'ë¡œ í™•ì¸í•˜ì„¸ìš”.\nì£¼ê¸°ì ìœ¼ë¡œ ë©”ì¼í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”! ì†Œì†Œí•œ ì—…ë°ì´íŠ¸ ë° ì´ë²¤íŠ¸ê°œìµœë“± ì—¬ëŸ¬ì†Œì‹ì„ í™•ì¸í•´ë³´ì„¸ìš”.",
                    colour=ctx.author.colour,
                )

                return await ctx.send(embed=mal)
            cur = await database.execute('SELECT * FROM mail')
            mails = await cur.fetchall()
            check = sum(1 for _ in mails)
            # noinspection DuplicatedCode
            cur = await database.execute("SELECT * FROM uncheck WHERE user_id = ?", (ctx.author.id,))
            # noinspection DuplicatedCode
            check2 = await cur.fetchone()
            if str(check) != str(check2[1]):
                mal = discord.Embed(
                    title=f'ğŸ“«ë¼ì´ì   ë©”ì¼í•¨ | {int(check) - int(check2[1])}ê°œ ìˆ˜ì‹ ë¨',
                    description="ì•„ì§ ì½ì§€ ì•Šì€ ë©”ì¼ì´ ìˆì–´ìš”.'`>ë©”ì¼`'ë¡œ í™•ì¸í•˜ì„¸ìš”.\nì£¼ê¸°ì ìœ¼ë¡œ ë©”ì¼í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”! ì†Œì†Œí•œ ì—…ë°ì´íŠ¸ ë° ì´ë²¤íŠ¸ê°œìµœë“± ì—¬ëŸ¬ì†Œì‹ì„ í™•ì¸í•´ë³´ì„¸ìš”.",
                    colour=ctx.author.colour,
                )

                await ctx.send(embed=mal)
    @commands.command(name='ì½”ë¡œë‚˜í˜„í™©', aliases = ["covid"])
    async def covid(self, ctx, *, countryName = None):
        covidSite = "http://ncov.mohw.go.kr/index.jsp"
        covidNotice = "http://ncov.mohw.go.kr"
        html = urlopen(covidSite)
        bs = BeautifulSoup(html, 'html.parser')
        latestupdateTime = bs.find('span', {'class': "livedate"}).text.split(',')[0][1:].split('.')
        statisticalNumbers = bs.findAll('span', {'class': 'num'})
        beforedayNumbers = bs.findAll('span', {'class': 'before'})

        #ì£¼ìš” ë¸Œë¦¬í•‘ ë° ë‰´ìŠ¤ë§í¬
        briefTasks = []
        mainbrief = bs.findAll('a',{'href' : re.compile('\/tcmBoardView\.do\?contSeq=[0-9]*')})
        for brf in mainbrief:
            container = []
            container.append(brf.text)
            container.append(covidNotice + brf['href'])
            briefTasks.append(container)
        print(briefTasks)

        # í†µê³„ìˆ˜ì¹˜
        statNum = []
        # ì „ì¼ëŒ€ë¹„ ìˆ˜ì¹˜
        beforeNum = []
        for num in range(7):
            statNum.append(statisticalNumbers[num].text)
        for num in range(4):
            beforeNum.append(beforedayNumbers[num].text.split('(')[-1].split(')')[0])

        totalPeopletoInt = statNum[0].split(')')[-1].split(',')
        tpInt = ''.join(totalPeopletoInt)
        lethatRate = round((int(''.join(''.join(statNum[3].split(',')).lstrip("'").rstrip("'"))) / int(tpInt)) * 100, 2)
        embed = discord.Embed(title="ì½”ë¡œë‚˜-19 ëŒ€í•œë¯¼êµ­ í˜„í™©", description="",color=0x5CD1E5)
        embed.add_field(name="ìë£Œì¶œì²˜ : ë³´ê±´ë³µì§€ë¶€", value="http://ncov.mohw.go.kr/index.jsp", inline=False)
        embed.add_field(name="ìµœì‹  ìë£Œ ì—…ë°ì´íŠ¸ ì‹œê°„",value="í•´ë‹¹ ìë£ŒëŠ” " + latestupdateTime[0] + "ì›” " + latestupdateTime[1] + "ì¼ "+latestupdateTime[2] +" ìë£Œì…ë‹ˆë‹¤.", inline=False)
        embed.add_field(name="í™•ì§„í™˜ì(ëˆ„ì )", value=statNum[0].split(')')[-1]+"("+beforeNum[0]+")",inline=True)
        embed.add_field(name="ì™„ì¹˜í™˜ì(ê²©ë¦¬í•´ì œ)", value=statNum[1] + "(" + beforeNum[1] + ")", inline=True)
        embed.add_field(name="ì¹˜ë£Œì¤‘(ê²©ë¦¬ ì¤‘)", value=statNum[2] + "(" + beforeNum[2] + ")", inline=True)
        embed.add_field(name="ì‚¬ë§", value=statNum[3] + "(" + beforeNum[3] + ")", inline=True)
        embed.add_field(name="ëˆ„ì í™•ì§„ë¥ ", value=statNum[6], inline=True)
        embed.add_field(name="ì¹˜ì‚¬ìœ¨", value=str(lethatRate) + " %",inline=True)
        embed.add_field(name="- ìµœì‹  ë¸Œë¦¬í•‘ 1 : " + briefTasks[0][0],value="ë§í¬ : " + briefTasks[0][1],inline=False)
        embed.add_field(name="- ìµœì‹  ë¸Œë¦¬í•‘ 2 : " + briefTasks[1][0], value="ë§í¬ : " + briefTasks[1][1], inline=False)
        embed.set_thumbnail(url="https://wikis.krsocsci.org/images/7/79/%EB%8C%80%ED%95%9C%EC%99%95%EA%B5%AD_%ED%83%9C%EA%B7%B9%EA%B8%B0.jpg")
        embed.set_footer(text='RYZEN#9999',
                         icon_url='https://cdn.discordapp.com/avatars/872714206246469662/810ef9d933f9985d82f441de0a03fb6b.webp?size=80')
        await ctx.send("ì½”ë¡œë‚˜-19 ëŒ€í•œë¯¼êµ­ í˜„í™©", embed=embed)  




def setup(bot):
    bot.add_cog(covid19(bot))